version: "3.9"

services:
  pg-primary:
    image: postgres:15
    container_name: pg-primary
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: appdb
    volumes:
      - pg-primary-data:/var/lib/postgresql/data
      - ./pg-primary/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./pg-primary/01_hba.sh:/docker-entrypoint-initdb.d/01_hba.sh
    ports:
      - "5432:5432"

  pg-replica1:
    image: postgres:15
    container_name: pg-replica1
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
      PGPASSWORD: secret        # For pg_basebackup authentication
      REP_USER: replica        # Replication user (created in init.sql)
      REPLICATION_SLOT: pg_replica1
    volumes:
      - pg-replica1-data:/var/lib/postgresql/data
      - ./replica/init_replica.sh:/init_replica.sh
    entrypoint: ["/init_replica.sh"]
    command: ["postgres"]
    depends_on:
      - pg-primary

  pg-replica2:
    image: postgres:15
    container_name: pg-replica2
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
      PGPASSWORD: secret
      REP_USER: replica
      REPLICATION_SLOT: pg_replica2
    volumes:
      - pg-replica2-data:/var/lib/postgresql/data
      - ./replica/init_replica.sh:/init_replica.sh
    entrypoint: ["/init_replica.sh"]
    command: ["postgres"]
    depends_on:
      - pg-primary

  pgpool:
    image: mrgreen007/pgpool:4.6.4
    container_name: pgpool
    ports:
      - "5433:5432"
    environment:
      # ðŸ”¹ Backends (pg-primary weight=0)
      PGPOOL_BACKEND_NODES: >
        0:pg-primary:5432:0,
        1:pg-replica1:5432:1,
        2:pg-replica2:5432:1
      PGPOOL_BACKEND_APPLICATION_NAMES: "pg-primary,pg_replica1,pg_replica2"

      # ðŸ”¹ Connection Pool Settings
      PGPOOL_NUM_INIT_CHILDREN: 16        # Number of child processes
      PGPOOL_MAX_POOL: 2                  # Connections per child per backend

      PGPOOL_POSTGRES_USERNAME: postgres
      PGPOOL_POSTGRES_PASSWORD: secret

      PGPOOL_ADMIN_USERNAME: postgres
      PGPOOL_ADMIN_PASSWORD: secret

      PGPOOL_SR_CHECK_USER: postgres
      PGPOOL_SR_CHECK_PASSWORD: secret

      PGPOOL_HEALTH_CHECK_USER: postgres
      PGPOOL_HEALTH_CHECK_PASSWORD: secret
      PGPOOL_HEALTH_CHECK_PERIOD: 5           # Check every 5 seconds
      PGPOOL_HEALTH_CHECK_TIMEOUT: 3          # 3 second timeout
      PGPOOL_HEALTH_CHECK_MAX_RETRIES: 3      # 3 retry before marking down
      PGPOOL_HEALTH_CHECK_RETRY_DELAY: 1      # 1 second between retries

      # ðŸ”¹ Replication Lag Check
      PGPOOL_SR_CHECK_PERIOD: 1            # Check every 1 second
      PGPOOL_DELAY_THRESHOLD_BY_TIME: 1000 # Detach if lag > 1 second (1000ms)
      PGPOOL_DELAY_THRESHOLD: 0            # Disable byte-based check (optional)

      # ðŸ”¹ Auto Failback (Auto-recovery)
      PGPOOL_AUTO_FAILBACK: "yes"
      PGPOOL_AUTO_FAILBACK_INTERVAL: 5

      PGPOOL_ENABLE_LOAD_BALANCING: "yes"
      PGPOOL_DISABLE_LOAD_BALANCE_ON_WRITE: "always"
      PGPOOL_CHECK_TEMP_TABLE: "catalog"

    depends_on:
      - pg-replica1
      - pg-replica2

volumes:
  pg-primary-data:
  pg-replica1-data:
  pg-replica2-data:
